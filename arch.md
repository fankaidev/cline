## Cline 核心逻辑架构

Cline 是一个 AI 助手，它可以利用命令行界面（CLI）和编辑器来帮助开发者完成各种任务。以下是 Cline 核心逻辑的概述：

### 1. 任务初始化

-   **任务创建**: 当用户提供任务描述和可选的图片时，Cline 会创建一个新的任务，并生成一个唯一的任务 ID。
-   **历史任务恢复**: Cline 允许用户从历史记录中恢复任务。恢复任务时，Cline 会加载之前的对话历史、消息记录等信息。

### 2. 对话管理

-   **API 对话历史**: Cline 使用 `apiConversationHistory` 存储与 API 提供者（例如 OpenAI、Anthropic）的对话历史。
-   **Cline 消息**: Cline 使用 `clineMessages` 存储与用户的交互消息，包括用户输入、助手回复、工具使用情况等。
-   **消息存储**: Cline 会将 API 对话历史和 Cline 消息存储到磁盘，以便在任务恢复时加载。

### 3. 核心循环：`recursivelyMakeClineRequests`

-   **用户输入处理**: Cline 接收用户输入（文本、图片等），并将其转换为 API 可以理解的格式。
-   **环境信息收集**: Cline 收集当前的工作区环境信息，例如可见文件、打开的标签页、终端状态、诊断信息等，并将这些信息添加到上下文中。
-   **API 请求**: Cline 使用 `attemptApiRequest` 函数向 API 提供者发送请求，并获取助手的回复。
-   **助手消息处理**: Cline 解析助手返回的消息，提取文本、工具使用信息等。
-   **工具使用**: 如果助手建议使用工具，Cline 会根据工具的类型执行相应的操作，例如：
    -   **文件读写**: 读取或写入文件内容。
    -   **命令行执行**: 在终端中执行命令，并获取输出。
    -   **代码定义查找**: 查找代码定义。
    -   **文件搜索**: 根据正则表达式搜索文件。
    -   **浏览器操作**: 启动浏览器，执行点击、输入等操作。
-   **用户反馈**: Cline 呈现助手消息和工具执行结果给用户，并等待用户反馈。用户可以批准、拒绝或提供反馈意见。
-   **循环迭代**: Cline 根据用户反馈和任务状态，决定是否继续执行工具、完成任务或重新评估任务。

### 4. 上下文管理

-   **上下文截断**: 为了避免上下文窗口超出限制，Cline 会根据需要截断对话历史。
-   **提及解析**: Cline 会解析用户输入中的提及（例如 `@file`、`@url`），并将相应的内容添加到上下文中。

### 5. 状态管理

-   **检查点**: Cline 会在任务执行过程中创建检查点，以便用户可以回滚到之前的状态。
-   **Diff 视图**: Cline 使用 Diff 视图向用户展示文件变更，并允许用户编辑或还原更改。

### 6. 其他功能

-   **自动审批**: Cline 可以根据用户设置自动批准某些工具的使用。
-   **忽略列表**: Cline 尊重 `.clineignore` 文件，避免访问被忽略的文件和目录。
-   **自定义指令**: 用户可以通过 `.clinerules` 文件或设置自定义指令来定制 Cline 的行为。

### 7. 终端管理

-   **终端创建和管理**: Cline 能够创建和管理 VS Code 的集成终端，用于执行 CLI 命令。
-   **命令执行**: Cline 可以在终端中执行命令，并实时获取命令输出。
-   **Shell 集成**: Cline 利用 VS Code 的 Shell 集成 API，实现与终端的无缝集成。

### 8. 浏览器管理

-   **浏览器会话**: Cline 能够启动和控制无头浏览器，用于执行 Web 相关的任务。
-   **浏览器操作**: Cline 可以模拟用户在浏览器中的操作，例如点击、输入、滚动等。
-   **截图和日志**: Cline 可以捕获浏览器截图和控制台日志，用于调试和测试。

### 9. 错误处理

-   **API 错误**: Cline 能够处理 API 请求失败的情况，并向用户提供重试选项。
-   **工具执行错误**: Cline 能够捕获工具执行过程中的错误，并向用户报告。

### 10. 模式切换

-   **计划模式**: 在计划模式下，Cline 专注于信息收集、问题提问和解决方案设计。
-   **执行模式**: 在执行模式下，Cline 执行具体的任务步骤。

希望这个概述对您有所帮助！